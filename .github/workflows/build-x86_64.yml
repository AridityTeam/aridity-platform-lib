name: Build Aridity Platform Library (x86_64)

on:
  push:
    branches: [master]
    paths:
      - ".github/workflows/**"
      - "src/**"
      - "AridityTeam.Platform.slnx"
      - "Directory.Build.props"
      - "Directory.Packages.props"

env:
  SOLUTION_FILE: "AridityTeam.Platform.slnx"

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        build_type: [Release, Debug]
        build_platform: [x64, x86]
        target_framework: [net10.0, net8.0, net472, netstandard2.0]
        include:
          - os: windows-latest
            artifact_name: "AridityTeam.Platform-${{ matrix.build_type }}-${{ matrix.build_platform }}-${{ matrix.target_framework }}-windows"
          - os: ubuntu-latest
            artifact_name: "AridityTeam.Platform-${{ matrix.build_type }}-${{ matrix.build_platform }}-${{ matrix.target_framework }}-linux"
            # skip older Windows-only frameworks
            exclude: 
              - target_framework: net472
              - target_framework: netstandard2.0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            10.x
            8.x

      - name: Setup MSBuild (Windows)
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v2

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.local/share/NuGet/Cache
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Validate Framework Compatibility
        shell: pwsh
        run: |
          $os = "${{ matrix.os }}"
          $framework = "${{ matrix.target_framework }}"
          
          if ($os -eq "ubuntu-latest" -and ($framework -eq "net472" -or $framework -eq "netstandard2.0")) {
            Write-Host "Skipping $framework on Linux as it may not be fully supported"
            exit 0
          }
          
          Write-Host "Building for $framework on $os"

      - name: Restore Packages
        run: |
          dotnet restore "${{ github.workspace }}/${{ env.SOLUTION_FILE }}" `
            --runtime ${{ matrix.build_platform == 'x64' && 'x64' || 'x86' }} `
            --verbosity minimal `
            --force-evaluate

      - name: Build Solution
        run: |
          dotnet build "${{ github.workspace }}/${{ env.SOLUTION_FILE }}" `
            --configuration ${{ matrix.build_type }} `
            --runtime ${{ matrix.build_platform == 'x64' && 'x64' || 'x86' }} `
            --framework ${{ matrix.target_framework }} `
            --no-restore `
            --verbosity minimal `
            --property:WarningLevel=0 `
            --property:Platform=${{ matrix.build_platform }}

      - name: Run Tests (if any)
        if: matrix.target_framework == 'net10.0'
        run: |
          dotnet test "${{ github.workspace }}/${{ env.SOLUTION_FILE }}" `
            --configuration ${{ matrix.build_type }} `
            --framework ${{ matrix.target_framework }} `
            --no-build `
            --verbosity normal `
            --logger "console;verbosity=normal"

      - name: Pack Libraries
        run: |
          dotnet pack "${{ github.workspace }}/${{ env.SOLUTION_FILE }}" `
            --configuration ${{ matrix.build_type }} `
            --framework ${{ matrix.target_framework }} `
            --runtime ${{ matrix.build_platform == 'x64' && 'x64' || 'x86' }} `
            --no-build `
            --output "${{ github.workspace }}/artifacts/packages" `
            --verbosity minimal

      - name: Create Artifact Archive
        shell: pwsh
        run: |
          $framework = "${{ matrix.target_framework }}"
          $platform = "${{ matrix.build_platform }}"
          $config = "${{ matrix.build_type }}"
          
          $binPath = "${{ github.workspace }}/bin/$platform/$config/$framework"
          $outputFile = "${{ matrix.artifact_name }}.tar.xz"
          
          if (Test-Path $binPath) {
            Write-Host "Packing output directory: $binPath"
            
            $items = Get-ChildItem $binPath -Recurse -File
            Write-Host "Found $($items.Count) files totaling $([math]::Round(($items | Measure-Object -Property Length -Sum).Sum / 1MB, 2)) MB"
            
            & tar -cJf $outputFile -C "${{ github.workspace }}/bin/$platform/$config" "$framework"
            
            if (Test-Path $outputFile) {
              $archiveSize = (Get-Item $outputFile).Length / 1MB
              Write-Host "Archive created: $outputFile ($([math]::Round($archiveSize, 2)) MB)"
            } else {
              Write-Error "Failed to create archive: $outputFile"
              exit 1
            }
          else
            Write-Host "##[warning] No build output found for $framework $platform $config"
            & echo "No build output" | Out-File -FilePath "skip-${{ matrix.artifact_name }}.txt"
          }

      - name: Upload Build Artifact
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}.tar.xz
            skip-${{ matrix.artifact_name }}.txt
          retention-days: 14
          if-no-files-found: warn

      - name: Upload Package Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.artifact_name }}
          path: ${{ github.workspace }}/artifacts/packages/*.nupkg
          retention-days: 14
          if-no-files-found: ignore

  build-summary:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Generate Build Report
        shell: pwsh
        run: |
          $artifacts = Get-ChildItem "artifacts" -Directory
          Write-Host "## Build Summary"
          Write-Host "Total artifacts generated: $($artifacts.Count)"
          foreach ($artifact in $artifacts) {
            Write-Host "- $($artifact.Name)"
          }
          
          $buildArtifacts = Get-ChildItem "artifacts" -Filter "*.tar.xz" -Recurse
          $skipFiles = Get-ChildItem "artifacts" -Filter "skip-*.txt" -Recurse
          
          Write-Host "Successful builds: $($buildArtifacts.Count)"
          Write-Host "Skipped builds: $($skipFiles.Count)"
